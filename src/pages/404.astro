---
import BaseLayout from '../layouts/BaseLayout.astro';

import getPosts from "../utils/getPosts";
import getPostData from "../utils/getPostData";

import {getSiteConfig} from "../utils/getSiteConfig";
const siteConfig = await getSiteConfig();

const title = '404';
const description = '404.';
const url = Astro.url.pathname;

function checkForRedirect() {
    const paths = getPosts().map((p: any) => siteConfig.blog_prefix + getPostData(p).path);

    const parts = url.split('/').filter(Boolean);
    const dateIndex = parts.findIndex((part, i, arr) =>
        /^\d{4}$/.test(part) &&        // year: 4 digits
        arr[i + 1] && /^\d{2}$/.test(arr[i + 1]) &&  // month: 2 digits
        arr[i + 2] && /^\d{2}$/.test(arr[i + 2])     // day: 2 digits
    );

    // If a date sequence is found, slice from there
    const result = (dateIndex !== -1 ? parts.slice(dateIndex) : parts);
    console.log('url', url);
    if (result.length > 0 && result[result.length - 1].includes('.')) {
        result.pop();
    }
    const searchPath = result.join('/');
    // console.log('searchPath', searchPath);

    const trimmedSearch = searchPath.trim();
    const matchedPath = trimmedSearch.length > 0
        ? paths.find(path => path.includes(trimmedSearch))
        : undefined;

    const redirectPath = matchedPath ? `/${matchedPath}` : null;
    return redirectPath ? {
        url: redirectPath,
        timing: 30
    } : null;
}

const redirect = checkForRedirect();
---
{redirect ? (
<meta
        http-equiv="refresh"
        content={ `${ redirect.timing ? redirect.timing : '0' }; url=${ redirect.url }` }
/>
    ) : null}

<BaseLayout title={title} description={description} permalink="">
    <div class="c404">
        <h1>404 - File Not Found</h1>
        {redirect && <h2>(maybe)</h2>}
        <hr/>
        <p class="shrug">¯\_(ツ)_/¯</p>

    {redirect
        ?
        (
            <div class="redirect">
                <div class="redirect-info">
                    The page you are looking for:
                </div>
                <div class="redirect-from-url">
                    {Astro.site.href}{url.substring(1)}
                </div>
                <div class="redirect-info">
                    may have been moved to:
                </div>
                <div class="redirect-to-url">
                    <a href={redirect.url}>
                        {Astro.site.href}{redirect.url.substring(1)}
                    </a>
                </div>
                <div class="redirect-info">
                    Please update your bookmarks.
                </div>
                <br/>
                <div class="redirect-instruction">
                    Redirecting in
                    <span id="redirect-countdown"
                          class="redirect-countdown">
                        {redirect.timing}
                    </span>
                    seconds...
                </div>
                <div class="redirect-instruction">
                    (Or you can click the new link above.)
                </div>

            </div>

        ) : (
            <p>Sorry. This page does not exist.</p>
        )}
        <hr/>

    </div>
</BaseLayout>

<script is:inline define:vars={{ redirect }}>
    let countdownValue = redirect?.timing;
    if (countdownValue) {
        // Update the display initially
        document.getElementById('redirect-countdown').textContent = countdownValue;

        // Set an interval that updates every second
        const interval = setInterval(() => {
            countdownValue--;

            // Update the displayed value
            document.getElementById('redirect-countdown').textContent = countdownValue;

            // If it hits zero, clear the interval and optionally do something else
            if (countdownValue <= 0) {
                clearInterval(interval);
                // Perform your redirect or other action here
            }
        }, 1000);
    }
</script>

